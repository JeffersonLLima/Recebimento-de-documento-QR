<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Documentos</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
        }
        input {
            padding: 8px;
            margin: 5px;
        }
        button {
            padding: 10px;
            cursor: pointer;
        }
        #resultado {
            font-weight: bold;
            margin-top: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
    </style>
</head>
<body>

<h2>Calculadora de Divergência Percentual</h2>

<label for="valorAntigo">MAWB:</label>
<input type="number" id="valorAntigo" placeholder="Digite o MAWB"><br>

<label for="valorNovo">DAE:</label>
<input type="number" id="valorNovo" placeholder="Digite o DAE"><br>

<button onclick="calcularDivergencia()">Calcular</button>

<p id="resultado"></p>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>

<script>
// Configuração do Firebase
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

// Inicializa o Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function calcularDivergencia() {
    let valorAntigo = parseFloat(document.getElementById("valorAntigo").value);
    let valorNovo = parseFloat(document.getElementById("valorNovo").value);
    
    if (isNaN(valorAntigo) || isNaN(valorNovo) || valorAntigo <= 0) {
        document.getElementById("resultado").innerText = "Por favor, insira valores válidos!";
        return;
    }

    let divergencia = ((valorNovo - valorAntigo) / valorAntigo) * 100;
    let mensagem = divergencia > 0 
        ? `Aumento de ${divergencia.toFixed(2)}%`
        : `Redução de ${Math.abs(divergencia).toFixed(2)}%`;

    // Verificação do status baseado na divergência
    let status = divergencia > 5 ? "Pendente" : "Apta para Embarque";

    // Exibe o resultado
    document.getElementById("resultado").innerText = `Resultado: ${mensagem}. Status: ${status}`;
}

// Função para carregar os documentos do Firestore
function carregarDocumentos() {
    const tabela = document.getElementById("document-list");
    db.collection("documentos").get().then(querySnapshot => {
        querySnapshot.forEach(doc => {
            const docData = doc.data();
            const novaLinha = document.createElement("tr");
            novaLinha.innerHTML = `
                <td>${docData.mawb}</td>
                <td>${docData.data}</td>
                <td>${docData.hora}</td>
                <td>${docData.peso} kg</td>
                <td>${docData.origem}</td>
                <td>${docData.destino}</td>
                <td>${docData.shc}</td>
                <td>${docData.status}</td>
                <td>
                    <input type="checkbox" 
                        onchange="alterarStatusEmbarcado(this, '${docData.mawb}')" 
                        ${docData.status === 'Embarcado' ? 'checked' : ''} 
                        ${docData.status === 'Embarcado' ? 'disabled' : ''} />
                </td>
                <td><button onclick="removerDocumento(this, '${doc.id}')">Remover</button></td>
            `;
            tabela.appendChild(novaLinha);
        });
    });
}

// Função para adicionar documentos na Firestore
document.getElementById("document-form").addEventListener("submit", function(event) {
    event.preventDefault(); // Impede o envio do formulário

    const mawb = document.getElementById("document-name").value;
    const data = document.getElementById("dataRecebimento").value;
    const hora = document.getElementById("horaRecebimento").value;
    const peso = document.getElementById("pesoDocumento").value;
    const origem = document.getElementById("origemDocumento").value;
    const destino = document.getElementById("destinoDocumento").value;
    const shc = document.getElementById("shcDocumento").value;
    const status = document.getElementById("statusDocumento").value;

    // Salvar o documento no Firestore
    db.collection("documentos").add({
        mawb: mawb,
        data: data,
        hora: hora,
        peso: peso,
        origem: origem,
        destino: destino,
        shc: shc,
        status: status
    }).then(() => {
        // Adiciona a linha na tabela
        const newRow = document.createElement("tr");
        newRow.innerHTML = `
            <td>${mawb}</td>
            <td>${data}</td>
            <td>${hora}</td>
            <td>${peso} kg</td>
            <td>${origem}</td>
            <td>${destino}</td>
            <td>${shc}</td>
            <td>${status}</td>
            <td><input type="checkbox" onchange="alterarStatusEmbarcado(this, '${mawb}')"/></td>
            <td><button onclick="removerDocumento(this)">Remover</button></td>
        `;
        document.getElementById("document-list").appendChild(newRow);

        // Limpa os campos após adicionar
        document.getElementById("document-form").reset();
    });
});

// Função para remover um documento do Firestore
function removerDocumento(button, docId) {
    const senhaCorreta = "Soeuseiasenh@"; // Defina a senha necessária para remoção
    const senha = prompt("Digite a senha para remover o documento:");

    if (senha === senhaCorreta) {
        db.collection("documentos").doc(docId).delete().then(() => {
            const row = button.parentElement.parentElement;
            row.remove();
        }).catch((error) => {
            alert("Erro ao remover o documento: " + error.message);
        });
    } else {
        alert("Senha incorreta. O documento não foi removido.");
    }
}

// Função de filtro para MAWB
function filtrarDocumento() {
    const searchTerm = document.getElementById("search").value.toLowerCase();
    const rows = document.querySelectorAll("#document-list tr");
    
    rows.forEach(row => {
        const mawbCell = row.querySelector("td");
        if (mawbCell) {
            const mawbValue = mawbCell.textContent.toLowerCase();
            row.style.display = mawbValue.includes(searchTerm) ? "" : "none";
        }
    });
}

// Função para alterar o status para "Embarcado"
function alterarStatusEmbarcado(checkbox, mawb) {
    const rows = document.querySelectorAll("#document-list tr");
    rows.forEach(row => {
        const mawbCell = row.querySelector("td");
        if (mawbCell && mawbCell.textContent === mawb) {
            const statusCell = row.querySelector("td:nth-child(8)");
            if (checkbox.checked) {
                statusCell.textContent = 'Embarcado';
                checkbox.disabled = true; // Desabilita o checkbox se marcado
            } else {
                statusCell.textContent = 'Apta para Embarque'; // Ou outro status inicial
            }
        }
    });

    // Atualiza o status no Firestore
    db.collection("documentos").where("mawb", "==", mawb).get().then(querySnapshot => {
        querySnapshot.forEach(doc => {
            db.collection("documentos").doc(doc.id).update({
                status: checkbox.checked ? 'Embarcado' : 'Apta para Embarque'
            });
        });
    });
}

// Carregar os documentos ao iniciar a página
carregarDocumentos();
</script>

</body>
</html>
